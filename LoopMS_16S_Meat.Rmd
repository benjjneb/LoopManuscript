---
title: "Evaluationg LoopSeq 16S on Retail Meat Samples"
author: "BJC"
date: "4/13/2020"
output: html_document
---

## Setup

Load libraries, set the working directory to the location of this Rmarkdown file (only necessary when running by hand), and read in filenames:
```{r, echo=FALSE}
library(dada2, quietly=TRUE); packageVersion("dada2") # Should be 1.15.4 or later
library(Biostrings, quietly=TRUE)
library(ShortRead, quietly=TRUE)
library(ggplot2, quietly=TRUE)
library(reshape2, quietly=TRUE)
set.seed(100)
setwd("~/LoopManuscript") # CHANGE ME to the location of this file
path <- "~/LoopData/16S/CallahanMeat" # CHANGE ME to the location of the fastq files
path.fig <- "Figures" # Relative path to where figures should be saved
path.rds <- "RDS" # Relative path to where RDS should be saved
fn <- list.files(path, pattern=".fq$", full.names=TRUE)
sapply(fn, function(f) length(getSequences(f)))
```

## QA, Filtering and Trimming

First do basic QA on these data, and then apply the DADA2 filtering and trimming workflow with the parameters selected from the detailed inspection of the Zymo mock community. Note that this data was generated alongside the Fecal data, so all parameters used there are expected to translate.

```{r}
plotComplexity(fn)
```

```{r}
plotQualityProfile(fn)
```

Remove the primers (and any flanking sequence) from the reads, and filter out reads that don't contain both primers:
```{r}
FWD <- "AGAGTTTGATCMTGGC" # Loop 16S forward primer
REV <- "TACCTTGTTACGACTT" # Loop 16S reverse primer
nop <- file.path(path, "nop", basename(fn))
out <- removePrimers(fn, nop, FWD, rc(REV), verbose=TRUE)
```

As in the fecal samples, only a modest (~40\%) proportion of sequences are passing the primer screen.

Filter the sequences and enforce minimum/maximum lengths appropriate for full-length 16S. Note that we are enforcing `maxEE=1`, as that was determined to be a better filter than `maxEE=2` in the Zymo mock community data.
```{r}
filt <- file.path(path, "filtered", basename(fn))
track <- filterAndTrim(nop, filt, maxEE=1, minLen=1400, maxLen=1600, verbose=TRUE)
```

Final inspection of the quality profile:
```{r, message=FALSE}
plotQualityProfile(filt)
```

Final progress of reads through filtering and trimming:
```{r}
cbind(raw=out[,1], primers=out[,2], filtered=track[,2])
```

Note that GB8 in particular had a large fraction (~80\%) of reads lost due to a failure to detect both primers.

# Denoising

Learn the error rates:
```{r, warning=FALSE}
err.rds <- file.path(path.rds, "err_16S_Meat.rds") # RDS save/load to speed up reruns of the code
if(!file.exists(err.rds)) {
  err <- learnErrors(filt, multi=TRUE, verbose=0)
  saveRDS(err, err.rds)
}
err <- readRDS(err.rds)
plotErrors(err, nominalQ=TRUE)
```

Denoise the filtered data into ASVs using current LoopSeq appropriate "high-sensitivity" settings:
```{r}
dd <- dada(filt, err, OMEGA_A=1e-10, DETECT_SINGLETONS=TRUE, multi=TRUE, verbose=0)
dd
```

Make sequence table and remove chimeras:
```{r}
sta <- makeSequenceTable(dd)
st <- removeBimeraDenovo(sta, minFoldParentOverAbundance=4.5, multi=TRUE, verbose=TRUE)
```

Assign taxonomy:
```{r}
tax.rds <- file.path(path.rds, "tax_16S_Meat.rds") # RDS save/load to speed up reruns of the code
if(!file.exists(tax.rds)) {
  tax <- assignTaxonomy(st, "~/tax/silva_nr_v132_train_set.fa.gz", minBoot=80, multi=TRUE)
  saveRDS(tax, tax.rds)
}
tax <- readRDS(tax.rds)
if(!identical(getSequences(tax), getSequences(st))) stop("Taxonomy mismatch.")
```

```{r}
table(tax[,"Phylum"], useNA="ifany")
```

```{r}
table(tax[,"Genus"], useNA="ifany")
```

Quite a lot of Yersinia is interesting, as that can be a foodborne pathogen, or a "commensal" or (infamously in microbiome papers) the plague. What is the abundance spectrum like?

```{r}
sq.yers <- getSequences(st)[tax[,"Genus"] %in% "Yersinia"]
names(sq.yers) <- paste0("Yersinia", seq_along(sq.yers))
unname(colSums(st[,sq.yers]))
```

Drops off quickly, but a number of well-supported Yersinia ASVs (>=10 reads). Taking a look at the Yersinia ASV distribution by sample (and note that rrndb supports mostly 7 gene copies, but 6 in some species as well)

```{r}
df <- cbind(data.frame(Sample=rownames(st)), st[,sq.yers])
dfm <- melt(df, id.vars="Sample", variable.name="Yersinia.ASV", value.name="Abundance")
ggplot(data=dfm[dfm$Abundance > 4,], aes(x=Yersinia.ASV, y=Abundance)) + geom_point() + facet_wrap(~Sample) + theme_bw()
```

Let's do some species-level assignments by hand for the top 32 Yersinias (all w/ 4+ reads).

```{r}
spec.yers <- c("enterocolitica", # 100
               "enterocolitica",
               "enterocolitica",
               "intermedia", # 100
               "intermedia", # 100
               "intermedia",
               "intermedia",
               "intermedia",
               "kristensenii", # 100
               "intermedia", # 100  -- 10th seq
               "intermedia", # 100
               "intermedia",
               "intermedia",
               "intermedia", #100
               "intermedia",
               "intermedia",
               "intermedia",
               "intermedia", #100
               "enterocolitica", # 100
               "frederiksenii", # -- 20th seq
               "enterocolitica",
               "enterocolitica",
               "enterocolitica",
               "frederiksenii", # 10-off
               "intermedia",
               "enterocolitica", # end of query not included (5% of read)
               "kristensenii",
               "enterocolitica",
               "intermedia", # 8-off of intermedia/kristensenii/aldovae, but cooccur patterns say intermedia
               "enterocolitica", # -- 30th seq
               "enterocolitica",
               "frederiksenii")
names(spec.yers) <- sq.yers[1:length(spec.yers)]
```

Y. enterolitica are the most common species causing human enteric (intestinal) yersiniosis. Pigs are the major animal reservoir for the few strains of Y. enterocolitica that cause human illness, but rodents, rabbits, sheep, cattle, horses, dogs, and cats also can carry strains that cause human illness. https://www.cdc.gov/yersinia/faq.html

Yersinia intermedia is not considered of clinical relevance, being isolated from humans in a routine manner. https://en.wikipedia.org/wiki/Yersinia_intermedia

Yersinia kristensenii is a species of bacteria.[1] It is Gram-negative and its type strain is 105 (=CIP 80-30). It is potentially infectious to mice.[2] It secretes a bacteriocin that targets related species. https://en.wikipedia.org/wiki/Yersinia_kristensenii

Yersinia frederiksenii is a Gram-negative species of bacteria.[1] It uses rhamnose and sucrose. Its type strain is strain 6175 (=CIP 80-29). In humans, it can cause gastrointestinal infections,[2] while it has also been found in fish. https://en.wikipedia.org/wiki/Yersinia_frederiksenii

So, *Y. enterolitica* is the main foodborne pathogen of concern here, the other Yersinias are not or very rarely associated with disease in humans.

```{r}
sty <- st[,sq.yers]
dfy <- data.frame(Sample=sapply(strsplit(rownames(st), "_"), `[`, 1), st[,sq.yers])
dfym <- melt(dfy, id.vars="Sample", variable.name="ASV", value.name="Abundance")
dfym$Genus <- "Yersinia"
dfym$Species <- spec.yers[dfym$ASV]
```

```{r}
ggplot(data=dfym[dfym$ASV %in% names(spec.yers) & dfym$Abundance > 0,], 
       aes(x=ASV, y=Abundance, color=Species)) + 
  geom_point() + theme_bw() + facet_grid(Sample~Species, scales="free_y") + ylim(c(0, NA))
```

```{r}
sq.yent <- names(spec.yers)[spec.yers == "enterocolitica"]
unname(outer(sq.yent, sq.yent,
             nwhamming, vec=TRUE))
```

So groups of similar sequences: 1/2/3/4/6/7/11, and 5/8/9 (although these are ~10nts from each other, but 30+ from the rest). 10 is off on its own.

In BLAST the first group are all close to the same Yersinia enterocolitica strain FORC-002, complete genome.
10 is also a match to that but with the end cut off -- chimera?

Actually all of 5/8/9 are that same way...

```{r}
unname(st[,sq.yent])
```

All of 5/8/9/10 cooccur in that first sample, along with the very high abundance top 3 seqs (which are probably one strain).

```{r}
sq.yent.last80 <- substr(sq.yent, nchar(sq.yent)-80, nchar(sq.yent))
dada2:::pfasta(sq.yent.last80)
```

Interesting, the 5/8/9/10 last 80s don't match any Yersinia sequences, and are only poor matches (sometimes) to Serratia in the broader Yersiniaceae group. However they match exactly to Streptococcus/Enterococcus sequences...

Is there a quality signal associated here?

```{r}
plot(dd[[1]]$quality[dd[[1]]$sequence==sq.yent[[1]],])
plot(dd[[1]]$quality[dd[[1]]$sequence==sq.yent[[2]],])
plot(dd[[1]]$quality[dd[[1]]$sequence==sq.yent[[5]],])
plot(dd[[1]]$quality[dd[[1]]$sequence==sq.yent[[10]],])
```

No, not really...

```{r}
bim <- isBimeraDenovo(sta, minFoldParent=4.5, allowOneOff=TRUE, multi=TRUE)
unname(bim[sq.yent])
```

Not sure at this point...

Looking more broadly at the samples using the following, and referencing against https://www.cdc.gov/foodsafety/diseases/index.html 
```{r}
i <- 4
unname(tax[order(st[i,], decreasing=TRUE),"Genus"][1:40])
sort(unname(tax[order(st[i,], decreasing=TRUE),"Genus"][1:40]))
```

It looks like overall I need to look into Escherichia/Shigella (samples 4/6), Clostridium (a few samples) and Yersinia.

List of bacteria of foodborne pathogen concern via CDC:

Bacillus anthracis: https://www.cdc.gov/anthrax/basics/ (prob not retail meat in US at least)
Clostridium botulinum: https://www.cdc.gov/botulism/general.html (prob not retail meat, disease from toxin not the usualy spore bacteria itself)
Brucella: https://www.cdc.gov/brucellosis/index.html (prob not meat, but possible)
*Campylobacter: https://www.cdc.gov/campylobacter/faq.html
Vibrio cholerae: https://www.cdc.gov/cholera/index.html (prob not in meat)
Cronobacter: https://www.cdc.gov/cronobacter/ (prob not in meat)
*Clostridium perfringens: https://www.cdc.gov/foodsafety/diseases/clostridium-perfringens.html (some strains)
*E. coli: https://www.cdc.gov/ecoli/ (STEC, EHEC, ETEC, Diarrheagenic types)
Streptobacillus moniliformis: https://www.cdc.gov/rat-bite-fever/ (prob not in meat)
Leptospira: https://www.cdc.gov/leptospirosis/ (prob not in meat)
*Listeria monocytogenes: https://www.cdc.gov/listeria/index.html
*Salmonella enterica: https://www.cdc.gov/salmonella/ (some serotypes, esp Enteritidis, Typhimurium, Newport, and Javiana)
Salmonella Typhi/Paratyphi: https://www.cdc.gov/typhoid-fever/ (prob not in US retail meat)
Shigella: https://www.cdc.gov/shigella/ 
Staphylococcus aureus: https://www.cdc.gov/foodsafety/diseases/staphylococcal.html (disease from toxin, not the common commensal itself)
Vibrio parahaemolyticus/vulnificus/alginolyticus: https://www.cdc.gov/vibrio/faq.html (prob not in meat)
*Yersinia enterocolitica: https://www.cdc.gov/yersinia/

In our 6 samples, we see quite a bit of Yersinia and Escherichia/Shigella, some Salmonella, and perhaps C. perfringens (not sure yet what sensu_stricto group that is in). No Campylobacter or Listeria is detected.

```{r}
# >NR_121697.2:24-1462 Clostridium perfringens ATCC 13124 16S ribosomal RNA, complete sequence
ex.Cperf <- gsub("\n", "", "TCAGGATGAACGCTGGCGGCGTGCTTAACACATGCAAGTCGAGCGATGAAGTTTCCTTCGGGAAACGGAT
TAGCGGCGGACGGGTGAGTAACACGTGGGTAACCTGCCTCATAGAGTGGAATAGCCTTCCGAAAGGAAGA
TTAATACCGCATAACGTTGAAAGATGGCATCATCATTCAACCAAAGGAGCAATCCGCTATGAGATGGACC
CGCGGCGCATTAGCTAGTTGGTGGGGTAACGGCCTACCAAGGCGACGATGCGTAGCCGACCTGAGAGGGT
GATCGGCCACATTGGGACTGAGACACGGCCCAGACTCCTACGGGAGGCAGCAGTGGGGAATATTGCACAA
TGGGGGAAACCCTGATGCAGCAACGCCGCGTGAGTGATGAAGGTTTTCGGATCGTAAAGCTCTGTCTTTG
GGGAAGATAATGACGGTACCCAAGGAGGAAGCCACGGCTAACTACGTGCCAGCAGCCGCGGTAATACGTA
GGTGGCGAGCGTTATCCGGATTTACTGGGCGTAAAGGGAGCGTAGGCGGATGATTAAGTGGGATGTGAAA
TACCCGGGCTCAACTTGGGTGCTGCATTCCAAACTGGTTATCTAGAGTGCAGGAGAGGAGAGTGGAATTC
CTAGTGTAGCGGTGAAATGCGTAGAGATTAGGAAGAACACCAGTGGCGAAGGCGACTCTCTGGACTGTAA
CTGACGCTGAGGCTCGAAAGCGTGGGGAGCAAACAGGATTAGATACCCTGGTAGTCCACGCCGTAAACGA
TGAATACTAGGTGTGGGGGTTTCAACACCTCCGTGCCGCCGCTAACGCATTAAGTATTCCGCCTGGGGAG
TACGGTCGCAAGATTAAAACTCAAAGGAATTGACGGGGACCCGCACAAGTAGCGGAGCATGTGGTTTAAT
TCGAAGCAACGCGAAGAACCTTACCTACACTTGACATCCCTTGCATTACTCTTAATCGAGGAAATCCCTT
CGGGGACAAGGTGACAGGTGGTGCATGGTTGTCGTCAGCTCGTGTCGTGAGATGTTGGGTTAAGTCCCGC
AACGAGCGCAACCCTTGTCGTTAGTTACTACCATTAAGTTGAGGACTCTAGCGAGACTGCCTGGGTTAAC
CAGGAGGAAGGTGGGGATGACGTCAAATCATCATGCCCCTTATGTGTAGGGCTACACACGTGCTACAATG
GCTGGTACAGAGAGATGCAATACCGCGAGGTGGAGCCAAACTTAAAAACCAGTCTCAGTTCGGATTGTAG
GCTGAAACTCGCCTACATGAAGCTGGAGTTACTAGTAATCGCGAATCAGAATGTCGCGGTGAATACGTTC
CCGGGTCTTGTACACACCGCCCGTCACACCATGAGAGTTGGCAATACCCGAAGTCCGTGAGCTAACCGCA
AGGAGGCAGCGGCCGAAGGTAGGGTCAGCGATTGGGGTG")

# >NR_036786.1:18-1456 Clostridium botulinum strain ELTDK 103 16S ribosomal RNA, partial sequence
ex.Cbot <- gsub("\n", "", "TCAGGACGAACGCTGGCGGCGTGCTTAACACATGCAAGTCGAGCGATGAAGCTTCCTTCGGGAAGTGGAT
TAGCGGCGGACGGGTGAGTAACACGTGGGTAACCTGCCTCAAAGTGGGGGATAGCCTTCCGAAAGGAAGA
TTAATACCGCATAACATAAGAGAATCGCATGATTTTCTTATCAAAGATTTATTGCTTTGAGATGGACCCG
CGGCGCATTAGCTAGTTGGTAAGGTAACGGCTTACCAAGGCAACGATGCGTAGCCGACCTGAGAGGGTGA
TCGGCCACATTGGAACTGAGACACGGTCCAGACTCCTACGGGAGGCAGCAGTGGGGAATATTGCGCAATG
GGGGAAACCCTGACGCAGCAACGCCGCGTGGGTGATGAAGGTCTTCGGATTGTAAAGCCCTGTTTTCTGG
GACGATAATGACGGTACCAGAGGAGGAAGCCACGGCTAACTACGTGCCAGCAGCCGCGGTAATACGTAGG
TGGCGAGCGTTGTCCGGATTTACTGGGCGTAAAGGGTGCGTAGGCGGATGTTTAAGTGGGATGTGAAATC
CCCGGGCTTAACCTGGGGGCTGCATTCCBAAACTGGATATCTAGAGTGCAGGAGAGGAAAGCGGAATTCC
TAGTGTAGCGGTGAAATGCGTAGAGATTAGGAAGAACACCAGTGGCGAAGGCGGCTTTCTGGACTGTAAC
TGACGCTGAGGCACGAAAGCGTGGGTAGCAAACAGGATTAGATACCCTGGTAGTCCACGCCGTAAACGAT
GGATACTAGGTGTAGGGGGTATCAACTCCCCCTGTGCCGCAGTTAACACAATAAGTATCCCGCCTGGGGA
GTACGGTCGCAAGATTAAAACTCAAAGGAATTGACGGGGGCCCGCACAAGCAGCGGACAGTGTGGTTTAA
TTCGAAGCAACGCAGAGAACCTTACCTGGACTTGACATCCCTTGCATAGCCTAGAGATAGGTGAAGCCCT
TCGGGGCAAGGAGACAGGTGGTGCATGGTTGTCGTCAGCTCGTGTCGTGAGATGTTAGGTTAAGTCCTGC
AACGAGCGCAACCCTTGTTATTAGTTGCTACCATTAAGTTGAGCACTCTAATGAGACTGCCTGGGTAACC
AGGAGGAAGGTGGGGATGACGTCAAATCATCATGCCCCTTATGTCCAGGGCTACACACGTGCTACAATGG
TAGGTACAATAAGACGCAAGACCGTGAGGTGGAGCAAAACTTATAAAACCTATCTCAGTTCGGATTGTAG
GCTGCAACTCGCCTACATGAAGCTGGAGTTGCTAGTAATCGCGAATCAGAATGTCGCGGTGAATACGTTC
CCGGGCCTTGTACACACCGCCCGTCACACCATGAGAGCTGGTAACACCCGAAGTCCGTGAGGTAACCGTA
AGGGAGCCAGCGGCCGAAGTGGATTAAGTGATTGGGGTG")

tt <- assignTaxonomy(c(ex.Cperf, ex.Cbot), "~/tax/silva_nr_v132_train_set.fa.gz", minBoot=80, multi=TRUE)
```

Now taking a look, first is C. perfringens, second is C. botulinum:
```{r}
unname(tt)
sum(tax[,"Genus"] %in% tt[1,"Genus"])
sum(tax[,"Genus"] %in% tt[2,"Genus"])
```

OK so those groups are both in the data, will have to take a closer look at each:

```{r}
sq.Css1 <- getSequences(st)[tax[,"Genus"] %in% "Clostridium_sensu_stricto_1"]
dada2:::pfasta(sq.Css1) # C. perfringens group
```

Yep, there is a lot of *C. perfringens* here.

```{r}
spec.Css1 <- c("perfringens", # 100
"perfringens",
"perfringens",
"perfringens", # 100
"perfringens",
"perfringens",
"perfringens",
"perfringens",
"perfringens",
"septicum", # SEQ 10
"perfringens",
"perfringens",
"septicum",
"septicum",
"perfringens",
"perfringens",
"perfringens", # 23-off
"perfringens",
"perfringens",
"perfringens", # SEQ 20
"septicum",
"perfringens")
names(spec.Css1) <- sq.Css1
```

Now for the C. botulinum group (Css18):

```{r}
sq.Css18 <- getSequences(st)[tax[,"Genus"] %in% "Clostridium_sensu_stricto_18"]
dada2:::pfasta(sq.Css18) # C. botulinum group
```

```{r}
spec.Css18 <- c("sporogenes", # 100
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", 
"sporogenes", # SEQ 10
"sporogenes", # 20-off
"sporogenes", # 17-off
"sporogenes", # 16-off, all at end
"sporogenes")
names(spec.Css18) <- sq.Css18
```

No *C. botulinum*.

Now what about Salmonella:
```{r}
sq.salm <- getSequences(tax)[tax[,"Genus"] %in% "Salmonella"]
unname(st[,sq.salm])
```

Interesting, *Salmonella* only shows up in one sample, and in very even counts across 7 ASVs. That is consistent with the 7 rrn copies that *Salmonella* has according to rrndb. So, what is that strain?

```{r}
dada2:::pfasta(sq.salm)
```

Some ASVs (e.g. 1 and 2) are not very discriminative, but Salmonella enterica subsp. enterica serovar Newport strain CFSAN003387, complete genome (https://www.ncbi.nlm.nih.gov/nucleotide/CP016014.1?report=genbank&log$=nucltop&blast_rank=37&RID=9CCPUEXF014) is the best match (usually tied with many others) for every single ASV. All are exact matches except ASV4 (2-off). ASV6 is the key discrimant, as this Newport accession is the only exact match to that ASV. Nice!

STILL TO DO, sq.Css1 (C. perfringens), E. coli, and revisit Yersinia again.

```{r}
sq.Cperf <- names(spec.Css1)[spec.Css1 == "perfringens"]
unname(st[,sq.Cperf])
```

So this pretty much just occurs in the 4th smple. There are singleton detections of other ASVs also i that sample, and in sample 1. Sample 6 has one each of 3/2/1 abundance ASVs. *C. perfringens* has almost all 10 rrn copied in rrndb. This is consistent with the 2:1(x8) ratio of abundance Cperf ASVs in Sample 4. Using the BLAST strategy to try to ID that strain more precisely:

```{r}
dada2:::pfasta(sq.Cperf[1:9])
```

Stores the top hits for each ASV in the `Docs/` subdirectory. Taking a look at the best accessions:
```{r}
hitdf <- read.table("Docs/Food_Sample4_Cperf_BHits.txt", sep="\t", header=TRUE, comment="#")
#hitdf
sort(table(hitdf$Description), decreasing=TRUE)
```

So three strains clearly come out on top w/ 5 best hits each: ATCC 13124, LLY_N11, NCTC13170.

According to https://link.springer.com/article/10.1186/s12864-018-4771-1, ATCC13124 is a non-poultry isolate that lacks pathogenic genes netB and VR-10B. https://www.frontiersin.org/articles/10.3389/fmicb.2017.02485/full also supports that ATCC13124 and NCTC13170 are closely related and lack netB, netE, netF, netG and cpe. (see also comment on this paper https://www.frontiersin.org/articles/10.3389/fmicb.2018.01856/full)

For ATCC13124 (the type strain) see: https://www.ncbi.nlm.nih.gov/pubmed/16825665
NCTC13170: couldn't find much info in the Genbank
LLY_N11: Complete Genome Sequences of Clostridium perfringens Strain LLY_N11, a Pathogenic Isolate of Necrotic Enteritis from a Healthy Chicken

OK, so... not sure where this is at this point in time. In my very brief look at the literature, the phylogenetics/genomics of C. perfringens seems still somewhat underdeveloped, and it is not even clear what the key food-poisoning associated genes are.

Now let's start taking a look at E. coli...

```{r}
sq.ec<- getSequences(tax)[tax[,"Genus"] %in% "Escherichia/Shigella"]
rowSums(st[,sq.ec])
unname(colSums(st[,sq.ec]))
```

Essentially no E. coli in the first 3 samples. Then E. ecoli abundance is dominated by samples 4/6, with 5 having an OOM or 2 fewer reads. A long tail of singletons ASVs. But also a lot of ASVs with significant abundance (e.g. 10+).

```{r}
unname(st[,sq.ec[colSums(st[,sq.ec])>=10]])
```

Sample 4 is full of E. coli, in different strains!





